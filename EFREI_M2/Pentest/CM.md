# Pentest

1 Présentation du cours  
2 Définitions  
3 Etapes d'un test d'intrusion  
4 Methodologie et outils associés au étapes  

## Définitions

Évolution du modèle de sécurité en entreprise :
- avant : Isolation (par-feu, reverse-proxy, DMZ), un seul point d'entrée très sécurisé, circulation libre à l'intérieur
- après : Plusieurs points d'entrée, plusieurs zones cloisonées, contrôle multiple

### Test d'intrusion

Objectif : Évaluer le niveau de sécurité d'un système (app web, app mobile, SI, AD, ...)  
Méthode : 1. Simuler un comportement malveillant, 2. Lancer une attaque, 3. Analyser et exploiter les risques  
Quand : À la fin d'un projet avant la mise en production mais aussi régulièrement 
Résultat : Proposer des recommandations et un plan d'action pour réduire les risques  

Contrairement àun simple audit de sécurité organisationnel, l'exploitation des vulnérabilités fait parti du TI.    
C'est une activité à risque tant pour l'auditeur que pour l'entreprise.  

Trois types :
- Boite Noire : Aucune info préalable (seulement nom du client, URL, IP)
- Boite Grise : Certains nombres d'infos comme des identifiants de connexion
- Boîte Blanche : Toutes les infos dont on a besoin + entretiens avec les développeurs, code source, ...

Il faut faire la différence entre test d'intrusion et scanner de vulnérabilité.  
Le scanner de vulnérabilité permet un contrôle en largeur (on peut lui passer un /24, /16, ...)  alors que les tests d'intrusion permet un contrôle en profondeur. Jamais un scanner de vuln ne va détailler un scénario pour exploiter une vulnérabilité.

### Red Team

Il performe des audits par objectifs et non par moyen (par exemple "prendre une photo de l'intérieur du coffre fort dans le bureau du PDG").  
Méthode : Intrusion physique, intrusion logique, externe et/ou interne, social engineering (téléphone, phising, etc ...), ...  

### Un auditeur

Qui est il ?  
Un acteur extérieur à un projet, cherchant à évaluer la sécurité afin de définir des correctifs.  
Un intervenant qui peut participer à toutes les phases d'un projet par différents type d'audit (Code, archi, intrusion, ...)  
Un avis spécialisé et indépendant sur la sécurité d'une entreprise resectant des valeurs éthiques et morales

Un auditeur se doit de respecter les législations et les contrats, l'intégrité du SI d'un client, le bon sens, ... 

## Etapes du test d'intrusion

- Business / Cadre contractuel
- Reconnaissance, Cartographie, Collecte d'informations
- Détection et analyse des vulns
- Exploit des vulns
- Post exploitation (comment on pourrait rebondir avec ce qu'on a exploité précédemment ?, Comment on pourrait effacer nos traces)
- Livrables ()
- Contre audit

### Business et cadre contractuel

Le client émet d'abord un appel d'offre :
- Cahier des charges (combien de systèmes)
- Exigence
- Contraintes
- Objectif du test
- Manière de tester 
- ...

LEs société de conseil y répondent avec une proposition commerciale :
- Discussions concernant l'appel d'offre
- Descriptif de l'entreprise et de ses activités
- Méthodologie prévue pour répondre au besoin
- Profils présélectionnés
- Prix

Le TI ne peut démarrer sans autorisation signée :
- Date
- IP
- Cibles
- Acteurs

### Reconnaissance, Carographie, Collecte d'informations

Il s'agit de la collecte d'un maximum d'informations.

Collecte passive :
- Whois, IP
- Réseaux sociaux
- Google
- Wireshark

Collecte active :
- DNS
- Scanner de port
- Collecte de banière (telnet)

#### WHOIS

Cela répertorie tous les sous-réseaux et leurs propriétaires respectifs. On peut vérifier que les IP appartiennent au client, on peut récupérer des IPs à partir de cette IP justement. On récupère aussi le nom de l'hébergeur, des contacts, ... On peut rentrer des noms de domaine ou des adresses des serveurs DNS pour récupérer d'autres informations.

#### Bases DNS

Les DNS peuvent être hébergés chez le client, il est donc possible de récupérer l'adressage interne.  
`host -t [ns|mx] <server_name>`.
On peut utiliser nslookup, dnsrecon, dnsenum...

#### Information Internet

On utilise le google dorking et the harvester (récupération d'emails pour faire du social engineering).

#### Protocole SMB

Protocole (port 129 et 445) permet de partager des ressources en local.
Vulnérabilité Null session Enumeration :
- Autorise la diffusion d'informations à des utilisateurs non authentifiés
	- IP
	- Politique de passwd
	- Utilisateurs
	- Enum4linux -a <IP>

#### Procole SNMP

Protocole utilisé par les administrateurs réseau pour gérer les équipements.  
SMNP v1 et v2 sont non chiffrés et ils utilisent un nom de communauté pour s'authntifier :
	- Public
	- Private

`Snmpwalk -c <communaute> -v1|v2 <IP>` : Informations réseau comme les IPs, les ports utilisés, logiciels installés...

### Détection et analyse de vulns

Le but est de trouver des vulns sur les systèmes précédemment découverts

Automatiquement :
- Scanners (Nessus, OpenVas, Burp)
- Scripts 

Manuellement :
- CVEdetals
- Exploit-DB
- Google

### Exploitation de vulnérabilités

C'est une étape directement des résultats de la précédente.  
On lance des attaques :
- Phising
- Injection de code
- Utilisation des exploits
- Buffer Overflow
- CSRF
- ...

Cette étape permet d'infiltrer ou compromettre le système mis à l'épreuve :
- Gain d'accès à des infos ou services protégés
- Élévation de privilèges
- Découverte de nouveaux systèmes, rebond et analyse de l'infrastructure sous-jacente

### Post exploitation

Il s'agit d'installer des outils additionnels afin de maintenir et/ou renforcer sa présence sur la machine vulnérable :
- Installation d'une backdoor
- Malware / rootir
- Utilisation d'outils via cette machine (rebond) pour compromettre d'autres systèmes, par exemple avec du port forwarding.
- Cassage de mots de passe
- Effacer ses traces

### Livrables

C'est l'étape la plus importante, c'est une phase de reporting, il permet d'exposer le déroulement des tests et donner les conclusions de l'audit :
- Qualifier les risques
- Qualifier le niveau global de sécurité du système testé
- Proposition des recommandations adaptées pour réduire les risques dans un plan d'action
- Réunion de restitution avec le client

Matrice de risque (insérer image matrice de risque)

Risque brut : le risque proposé par l'audit
Risque réel : le risque lié au contexte, il est donc défini par l'entreprise 

Le livrale est composé de deux parties :
- Synthèse managériale (1 à 2 page)
	- Langage non technique
	- Explication des risques encourus et leurs potentiels impacts
	- Qualification du niveau global de sécurité
- Partie technique
	- Explication des vulnérabilités
		- Constat
		- Preuve d'audit (screenshots, ...)
		- Risque encouru
		- Recommandation
	- Détail des tests effectués
	- Classification des vulnérabilités
		- Critique 
		- Majeure
		- Moyenne
		- Basse
		- Prise en compte de l'impact principalement
		- La complexité
	- Proposition d'un plan d'action et des recommandations à mettre en place
		- Echelons chronologique
		- Difficulté de mise en oeuvre
		- Coût ?

### Contre audit

C'est une étape optionelle. Il s'agit juste de vérifier que le client a bien réduit les risques. Elle est faite généralement quelques semaines ou quelques mois après l'audit. C'est un re-test des vulns qui avaient été découvertes lors du TI. Il s'agit d'une rédaction d'un nouveau livrable sous forme du tableau. Il montre l'évolution du niveau de sécurité entre les deux TI.

## Différents type d'audit

### Audit d'architecture

Le but de ce type d'audit est de savoir si les équipements réseaux sont placés au bon endroit et de vérifier ce qui transit dans le réseau :
- Réguler les contacts extérieurs et controler les flux interne
- Focus sur FW et Switch
- Plan du réseau nécessaire, ACLs
	- Déterminer les politiques de réseau de l'entreprise
	- Présence d'un WAF (rupture SSL, manque de comptabilité CMS)
	- VLANs présent
	- DMZ   
- L'espace utilisateur (interne)
	- AD (politique de droit)
- L'espace public (invité)

### Audit de configuration

Il s'agit d'executer des scripts pour récupérer la configuration des cibles
Voici un ensemble des points de contrôle :
- Système à jour
	- Tous les modules embarqués doivent être surveillés aussi
	- Travail de veille à faire avant et pendant la mission
- Surface exposée réduite au minimum
	- Ne proposer que les fonctionnalités nécessaire au fonctionnement
- Gestion des droits d'accès
	- Réduit la fuite de données en cas d'intrusion



















